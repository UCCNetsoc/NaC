- hosts: control
  gather_facts: no
  become: yes
  roles:
    - ansible
    - git

- hosts: control
  tasks: 
    - set_fact:
        sysadmins:
          - { name: eric,     public_key: "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDIH9yhmm/hMX3FHK5TAaSwYHGl94CrG56Sy7CQNTymlsq3XFMuP2cWuTUNwj3uN22Mj+id+6AhvcttE5o5h3ASuVWY51CKHsq1NliOAnPUlSN5X9EEWbeYzAN5aWaars4Kwvrhf22TrPqVI7kjiRIF2ikR3j4tSyrX7Bjtn9WIsYzFGTCrGTFCKa8ImjwxKSJkRmiuuVRKoofk4M+517G7vRl9Q/14fpp9SndmSIosQFXUyEVTX66h2Uu3feOKB3XUSps6I8UicVmnXO0ZNS/YpWKK2oiA6RVbVRzPBAZx/RoQYhJ2t8rlMTdadZvOL+8WUGKlKcSMQ6+rLV9Z6FhIiXdxHoQGLA1R2R83CGltN44DmT/G3pa0Jcl3k0YJ1Qyxnb5WOq/BoTscCSIdnfHN9K9pFgICjt4qa1s9sSxg0YgSZhVo2FUMBj7EJZVWmA5dda50hdnmAFPD6TLrcFwi6YHi1S2WYklXATkobUanbov70os87yT8i7xX48sah5rE9vzr7EiiFDuF+9QpH42Nog49JqOo4ypTYiBl7rL0RBpAekHTmUKM0MukPvdNNX8FBdkcDX0kSqlNlosysg/fJkGxsZWRRpfB4pl1Q23q+LDcjswyJOF0Nwta+ILtyQdanx1Zs0peqjiwZjOe1fM9k8hDtXcLIxvMI4qZCdM5cQ==" }
          - { name: jac,      public_key: "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDwrBcldRunun/bN5EfBmUKGf2exQscaNaRv/6C97IOWpfmaTvu7VoObkJhxkvYjqs2ZEnpvVgegXN1yQ0Tq+hO2c3ZHbn6aOAlwcAC8ToYkjq/cpnAYpQr4PRiDennIeQzzbF5vZZXNA37rHToc0GAHvFWlwemDaWiCOXZzK6KLpTT4kiWcKI8FowcJ0z/UDCGAaA4rRuntcbfvvkoZjXxgbL0nW6LakZutAFO9SM8RGHiu9NYCw3aKV8ggAfwE09ojszcE/TgHkeGXnHalsqLLGmEgboaiGgozsO6J9/iMYEmNf9M4LPxuIVUYTbF4HduRDsIhzAcinUrda0tdli64gBcfObQgUFFho7RRezZk5Ofyq87oWz5rDZivxGx6BfdGx3u8WiGekIx7m9RV6irdpCMMcKmxRQ++9u9dPstrJQlkq0bkb+FNGPzfagCvbrIJx+2rjotAfD6DF18JrPIpzQdlXnPKmkb3+iCcpEXHiKNQiDf9SV1kxWkCby7LBYllfZhqhYuZnjMTMtLdc8D2UJXawVL7JYXBeD9e/9tyK2Bp1CFymftCL9wCLU8hlSbZ/sItcxD+4EoZpBs+UK+TyUpPTEAwCRtzECjXk8Ppba0EyTDXnvTtNRRElYJDBFq8ZVSrBKrfI4KNXa+vrhd0h7b0spAt39zAy4dZOpqKw==" }
          - { name: arthan,   public_key: "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDTYW99tbx5gUgTqvbQVRj27Lhz6A3ugS70RsbLxKso5OxcrOJJ4RPwpyT0hYekUV/usigqshnirGUqnuA3wl3J4N2WI2gVbUaOKJmbrAlTRgQvEmAACztXSmlRgBQ7g04OKpC9f/Ira924JbYzgpiPmoJDJZ+QOKmAdJHHVlFI6EzGAk8GNLHF1FpTxWXtKMOTYlW0VURf1dy4yO/8d8+cw4wRd4Q39/6ESNjo9TrxSvPNO8yWw/XmL5YVCFZ1sV/q0f5TiBN9fuoTv0peKGbdLJGU8AzRfuJT4DJSs8AwAn8Ug09VuPrnjlDS9PmeQlxYD6PsmmmHu76I31gU1u2BP2h5AkdbIb//3AuvA4VUZzTePDeE4ozfHwWJY5JPlWpvTPJSOMAfY9ZP1EzZY+Mw3U2JyLwVtamlF6Qt4zPz+cPH0iRNr8GsfN+1YdaEQ1eP/X+PlvlbvEzDAvn51QTHW6dqrp1uRaK7glT17MgWb4bonDtt3A1j6pW9KizRomo58HxnFtElMLTBLcrdka1p8VzwIrhkMOFepoWUB7ozOqS6hyokb4yeQgkTOmTCU6sc5tRPjxNaA0S6NXi7nz30QQysLKGb4mda0DsFIqudad9sqIzGjyvvsFUCYBqGnTONsQHD1RQClvTa7UyzBWbcYftAzUIBOIakpwBofuZFnw==" }
          - { name: thomas,   public_key: "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDELuxQz6pZKnoEz/8rpNNMKiBEqplDQ63oZiU11zqhUPhI9XzCdWTDUjiEjGzbiOjj9B+ls3HBCn0EEuXzfEohz5g2Vd8BNs85gP0j1xyQ3CtYybD3UhTLPVlmSezZxDwb1/tzgfh8asJh6eFOLH7Z7v6BNMYuFblCFIzN9COVCegxpnBBGszBBgfAGDyc8ayEZxIeTnckTsLqv+0nYb3ud2bF9HWToXRMljPbfwBLGezQRrr6S4SrTQzlQT86kGJjzYTT/UrQUOMTN4zDb205ZAtPqnlqNyr8146w/hXydzhF04eX94xZerazXZzgxez3GsWN/g9nzqwkLtTjoX83qAftTz8SPioRvuXUptYCma9DyNEm4VeCAVzbsH9geOgMbzBjYqGwuTPQiX6bD7ItgQzEs9uVRMMcIhBMFrE45ecLAA/o/0s9r+7jUDeG26e+EwtluRmVdnGm5KzIkg1zCWUn+Pxg3AslmUAssMuZJKGJV0FyBJsganSE7pQWQN0swdqN9AyZm5AMyiEpGddzZ90AEqDGm5iYJFrPnk3wv7uHqI8ChTd2NC4id6qrUhtr9kf5ebtvbItzIwpzKkZA5/7wOlrBsxlyeBKyyuAef4umduRC0/UCEPF74Lel545p5IgprNTx1UZSTcaMS9/2VMbyGRxvoDcRrsPkpkhZKw==" }
          - { name: strum355, public_key: "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIIz3MrCIBKCBFzoE+jQkKcR3kzf5LHx2XAuFsHmVhsWs" }
          - { name: ocanty,   public_key: "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC6KgSclCW2dhdtPc7AfyvOjr9nL+0pQIMRWGtv2AjMNOXfrCf3aOWhiUug1FbEPC+vjYGPaDc4hplj3Kfb5AaVYsY9XF48v1x9hiBtxiyE/BdFNa7aMzXT4qx3GS/kuw/P9CJaYPTTPplase98hTljU13VQrlveh5t1xM1tLLR7y5/adbl3UyMyFY5V+HT1nWns01qsZMe2m0q4Uvz2UbvIlYD5cN3OjTCrMtfeLQGeBOm/ScpkNTbNxu9nomBa6NW3MOp3g3JjBfut4RRZPgWGXfFj0CKBVKTaXc/OFtf5JlcnWpSY6f8DZbW2V8Ymssasqq4HnT4fhA27iwvHoUF4exmgH5B4jtFRZccRyF1W+t9Rxb8EN/MfgMxh1mHCiSBSaNwGCxeNTMT1ZgkWmDcT2GoCJmkVUdF3JbKk26gjVDTI8gDM/Td8cLbgIwc+iLWNd6MXhOR5jt9OsvrT71RV9t0z0RyT/2KsaxJe8UVrI+48va+TpSRfyBcv+BelAE=" }
            # - { name: mloc,     key: }
            # - { name: oisinaylward, key: }
            # - { name: fordetek, key: }

- name: Setup SysAdmin accounts
  hosts: control
  tasks:
    - name: Create netsoc_sysadmin Linux group
      group:
        name: netsoc_sysadmin
        state: present
        
    - name: Create SysAdmin Linux accounts 
      user:
        name: "{{ item.name }}"
        state: present
        group: netsoc_sysadmin
        create_home: yes
      with_items: "{{ sysadmins }}"

    - name: Authorize SysAdmin SSH keys
      authorized_key:
        user: "{{ item.name }}"
        key: "{{ item.public_key }}"
        state: present
      with_items: "{{ sysadmins }}"

    - name: Add SysAdmins to sudo
      lineinfile:
        path: /etc/sudoers
        regexp: "%admins ALL=(ALL) ALL"
        line: "%netsoc_sysadmin ALL=(ALL) ALL"

    - name: Create netsoc_sysadmin Proxmox group (if it doesn't exist) and give it admin role 
      shell: |
        pveum group list --output-format=json | jq .[].groupid | grep netsoc_sysadmin || pveum group add netsoc_sysadmin -comment 'Netsoc SysAdmins'
        pveum aclmod / -group netsoc_sysadmin -role Administrator

    - name: Create Proxmox-PAM users for Netsoc SysAdmin Linux accounts (if they don't exist)
      shell: |
        pveum user list --output-format=json | jq .[].userid | grep {{ item.name }}@pam || pveum user add {{ item.name }}@pam --groups netsoc_sysadmin
      with_items: "{{ sysadmins }}" 
