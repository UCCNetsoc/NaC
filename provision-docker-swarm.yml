---
- name: "Initial setup"
  hosts: docker_swarm
  become: yes
  roles:
    - ansible-requirements
    - utf8-locale
    - docker
  tags:
    - initial

- name: "Enroll in IPA server"
  hosts: docker_swarm
  roles:
    - role: freeipa-client
      vars:
        client:
          addresses:
            - "{{ ansible_default_ipv4.address }}"
  vars_files:
    - "vars/freeipa.yml"
    - "vars/network.yml"
    - "vars/secrets.yml"

- name: "Ensure directories"
  hosts: docker_swarm_managers[0]
  become: yes
  tasks:
    - file:
        path: "/storage/{{ item }}"
        state: directory
        recurse: yes
      with_items:
        - "docker/"

- name: "Ensure Docker Swarm created" 
  hosts: docker_swarm_managers
  roles:
    - role: docker-swarm-create
      when: "ansible_play_hosts_all.index(inventory_hostname) == 0"
    - role: docker-swarm-enroll-manager
      when: "ansible_play_hosts_all.index(inventory_hostname) > 0"
      vars:
        swarm_creator: "{{ groups['docker_swarm_managers'][0] }}"

- name: "Ensure Docker Swarm workers enrolled"
  hosts: docker_swarm_workers
  roles:
    - docker-swarm-enroll-worker
  vars:
    swarm_creator: "{{ groups['docker_swarm_managers'][0] }}"